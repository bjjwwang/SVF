name: svf-windows-build

on: [push]

env:
  SVF_CTIR: 1
  SVF_Z3: 1
  SVF_DIR: $GITHUB_WORKSPACE
  LLVM_URL: "https://github.com/bjjwwang/SVF-LLVM/releases/download/16.0.0/llvm-windows-build.zip"
  Z3_URL: "https://github.com/Z3Prover/z3/releases/download/z3-4.15.0/z3-4.15.0-x64-win.zip"
  INSTALL_DIR: ${{ github.workspace }}/install

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2

      - name: Download and extract LLVM
        run: |
          Invoke-WebRequest -Uri $env:LLVM_URL -OutFile llvm.zip
          Write-Host "Current directory before extraction:"
          Get-ChildItem
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE\llvm-windows-build"
          Expand-Archive -Path llvm.zip -DestinationPath "$env:GITHUB_WORKSPACE\llvm-windows-build" -Force
          Write-Host "Current directory after extraction:"
          Get-ChildItem
          $env:LLVM_DIR = "$env:GITHUB_WORKSPACE\llvm-windows-build"
          echo "LLVM_DIR=$env:LLVM_DIR" >> $env:GITHUB_ENV
          Write-Host "LLVM directory structure:"
          Get-ChildItem -Path $env:LLVM_DIR -Directory | ForEach-Object {
            Write-Host "`n$($_.Name):"
            Get-ChildItem -Path $_.FullName -Directory | ForEach-Object {
              Write-Host "  $($_.Name)"
            }
          }

      - name: Download and extract Z3
        run: |
          Invoke-WebRequest -Uri $env:Z3_URL -OutFile z3.zip
          Expand-Archive -Path z3.zip -DestinationPath .
          $env:Z3_DIR = "$env:GITHUB_WORKSPACE\z3-4.15.0-x64-win"
          echo "Z3_DIR=$env:Z3_DIR" >> $env:GITHUB_ENV

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: '3.23.0'

      - name: Build SVF
        run: |
          mkdir build
          cd build
          $cmakeArgs = @(
            "..",
            "-G", "Ninja",
            "-DCMAKE_BUILD_TYPE=Debug",
            "-DLLVM_DIR=$env:LLVM_DIR",
            "-DZ3_DIR=$env:Z3_DIR",
            "-DSVF_USE_PIC=ON",
            "-DBUILD_SHARED_LIBS=ON",
            "-DSVF_ENABLE_RTTI=ON",
            "-DCMAKE_INSTALL_PREFIX=$env:INSTALL_DIR"
          )
          cmake $cmakeArgs
          cmake --build . --config Debug
          cmake --install .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: svf-windows
          path: ${{ env.INSTALL_DIR }}
          retention-days: 5 

      - name: Clone SVF-windows-CI
        run: |
          git clone https://github.com/bjjwwang/SVF-windows-CI.git
          $env:TEST_FILE = "$env:GITHUB_WORKSPACE\SVF-windows-CI\CWE121_Stack_Based_Buffer_Overflow__CWE131_memcpy_01.c.bc"
          echo "TEST_FILE=$env:TEST_FILE" >> $env:GITHUB_ENV

      - name: Set AE_EXE environment variable
        run: |
          $env:AE_EXE = "$env:INSTALL_DIR\bin\ae.exe"
          echo "AE_EXE=$env:AE_EXE" >> $env:GITHUB_ENV

      - name: Verify AE executable and test file
        run: |
          if (Test-Path $env:AE_EXE) {
              Write-Host "AE executable found at: $env:AE_EXE"
          } else {
              Write-Host "AE executable not found at: $env:AE_EXE"
              exit 1
          }

          if (Test-Path $env:TEST_FILE) {
              Write-Host "Test file found at: $env:TEST_FILE"
          } else {
              Write-Host "Test file not found at: $env:TEST_FILE"
              exit 1
          }

      - name: Run AE test
        shell: pwsh
        run: |
          Write-Host "`n========= AE Executable Test Start ========="

          # Check env vars
          if (-not $env:AE_EXE) {
            Write-Error "âŒ AE_EXE environment variable is not set!"
            exit 1
          }
          if (-not (Test-Path $env:AE_EXE)) {
            Write-Error "âŒ AE_EXE path does not exist: $env:AE_EXE"
            exit 1
          }

          if (-not $env:TEST_FILE) {
            Write-Error "âŒ TEST_FILE environment variable is not set!"
            exit 1
          }
          if (-not (Test-Path $env:TEST_FILE)) {
            Write-Error "âŒ TEST_FILE does not exist: $env:TEST_FILE"
            exit 1
          }

          Write-Host "`nâœ… AE_EXE and TEST_FILE are valid"
          Write-Host "`nğŸ‘‰ AE_EXE: $env:AE_EXE"
          Write-Host "ğŸ‘‰ TEST_FILE: $env:TEST_FILE"

          # Run --help
          Write-Host "`nğŸš€ Running ae.exe --help:"
          try {
            $helpOutput = & $env:AE_EXE --help 2>&1
            Write-Host "`nğŸ“„ Help output:"
            Write-Host $helpOutput
          } catch {
            Write-Error "âŒ Error running ae.exe --help: $_"
          }

          # Run test file
          Write-Host "`nğŸš€ Running ae.exe -overflow with test file:"
          try {
            $testOutput = & $env:AE_EXE -overflow $env:TEST_FILE 2>&1
            Write-Host "`nğŸ“„ Test output:"
            Write-Host $testOutput
          } catch {
            Write-Error "âŒ Error running ae.exe on test file: $_"
          }

          Write-Host "`n========= AE Executable Test End ========="



