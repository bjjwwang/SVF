name: svf-windows-build

on: [push]

env:
  SVF_CTIR: 1
  SVF_Z3: 1
  SVF_DIR: $GITHUB_WORKSPACE
  LLVM_URL: "https://github.com/bjjwwang/SVF-LLVM/releases/download/16.0.0/llvm-windows-build.zip"
  Z3_URL: "https://github.com/Z3Prover/z3/releases/download/z3-4.15.0/z3-4.15.0-x64-win.zip"

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2

      - name: Download and extract LLVM
        run: |
          Invoke-WebRequest -Uri $env:LLVM_URL -OutFile llvm.zip
          Write-Host "Current directory before extraction:"
          Get-ChildItem
          Expand-Archive -Path llvm.zip -DestinationPath . -Force
          Write-Host "Current directory after extraction:"
          Get-ChildItem
          $env:LLVM_DIR = "$env:GITHUB_WORKSPACE\llvm-windows-build"
          echo "LLVM_DIR=$env:LLVM_DIR" >> $env:GITHUB_ENV
          Write-Host "LLVM directory structure:"
          Get-ChildItem -Path $env:LLVM_DIR -Directory | ForEach-Object {
            Write-Host "`n$($_.Name):"
            Get-ChildItem -Path $_.FullName -Directory | ForEach-Object {
              Write-Host "  $($_.Name)"
            }
          }

      - name: Download and extract Z3
        run: |
          Invoke-WebRequest -Uri $env:Z3_URL -OutFile z3.zip
          Expand-Archive -Path z3.zip -DestinationPath .
          $env:Z3_DIR = "$env:GITHUB_WORKSPACE\z3-4.15.0-x64-win"
          echo "Z3_DIR=$env:Z3_DIR" >> $env:GITHUB_ENV

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v1.14
        with:
          cmake-version: '3.23.0'

      - name: Build SVF
        run: |
          mkdir build
          cd build
          $cmakeArgs = @(
            "..",
            "-G", "Visual Studio 17 2022",
            "-A", "x64",
            "-DCMAKE_BUILD_TYPE=Release",
            "-DLLVM_DIR=$env:LLVM_DIR",
            "-DZ3_DIR=$env:Z3_DIR",
            "-DSVF_CTIR=ON",
            "-DSVF_Z3=ON"
          )
          cmake $cmakeArgs
          cmake --build . --config Release 